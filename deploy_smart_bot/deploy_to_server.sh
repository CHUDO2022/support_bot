#!/bin/bash

echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Support Bot v4 Ð½Ð° Linux ÑÐµÑ€Ð²ÐµÑ€"
echo "========================================"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° Linux
if [[ "$OSTYPE" != "linux-gnu"* ]]; then
    echo "âŒ Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð´Ð»Ñ Linux ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° root
if [[ $EUID -eq 0 ]]; then
    echo "âš ï¸  ÐÐµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¾Ñ‚ root. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ."
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
sudo apt update && sudo apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
sudo apt install -y python3 python3-pip python3-venv git curl wget unzip htop

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
BOT_DIR="$HOME/bots/support_bot"
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸: $BOT_DIR"
mkdir -p "$BOT_DIR"
cd "$BOT_DIR"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo "ðŸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
python3 -m venv venv
source venv/bin/activate

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ (ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸)
if [ -f "main.py" ]; then
    echo "âœ… Ð¤Ð°Ð¹Ð»Ñ‹ Ð±Ð¾Ñ‚Ð° ÑƒÐ¶Ðµ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚"
else
    echo "âŒ Ð¤Ð°Ð¹Ð»Ñ‹ Ð±Ð¾Ñ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹!"
    echo "ðŸ“‹ Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð±Ð¾Ñ‚Ð° Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ $BOT_DIR"
    echo "ðŸ“ ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:"
    echo "   - main.py"
    echo "   - file_manager.py"
    echo "   - text_cleaner.py"
    echo "   - human_behavior.py"
    echo "   - smart_file_detector.py"
    echo "   - requirements.txt"
    echo "   - env_example.txt"
    echo "   - ÐšÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸/ (Ð¿Ð°Ð¿ÐºÐ°)"
    echo "   - Ð¢Ð—.xlsx"
    exit 1
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install --upgrade pip
pip install -r requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f .env ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    cp env_example.txt .env
    echo "âš ï¸  Ð’ÐÐ–ÐÐž! ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð»:"
    echo "   nano .env"
    echo "   Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"
    read -p "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ .env Ñ„Ð°Ð¹Ð»Ð°..."
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
SERVICE_FILE="/etc/systemd/system/support-bot.service"
sudo tee "$SERVICE_FILE" > /dev/null << EOF
[Unit]
Description=Support Bot v4 - Smart Bot
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$BOT_DIR
Environment=PATH=$BOT_DIR/venv/bin
ExecStart=$BOT_DIR/venv/bin/python3 main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd..."
sudo systemctl daemon-reload

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº
echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
sudo systemctl enable support-bot

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ
echo "â–¶ï¸  Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
sudo systemctl start support-bot

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°:"
sudo systemctl status support-bot --no-pager

echo ""
echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
echo ""
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:     sudo systemctl status support-bot"
echo "   Ð›Ð¾Ð³Ð¸:       sudo journalctl -u support-bot -f"
echo "   ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:  sudo systemctl stop support-bot"
echo "   Ð—Ð°Ð¿ÑƒÑÐº:     sudo systemctl start support-bot"
echo "   ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: sudo systemctl restart support-bot"
echo ""
echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ð±Ð¾Ñ‚Ð°: $BOT_DIR"
echo "ðŸ“ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ: $BOT_DIR/.env"
echo "ðŸ“Š Ð›Ð¾Ð³Ð¸: sudo journalctl -u support-bot -f"

